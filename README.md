
# 資料服務使用注意事項 #

 

## 文件說明

本文件主要係提供使用公共運輸整合流通服務平臺（PTX）各項資料服務加值業者，在程式開發過程中常見問題的處理方式及資料使用的注意事項，使開發者能更快速地掌握PTX APIs的資料特性，並避免在旅運加值應用上資料運用錯誤。


## 服務使用注意事項

- **能否允許在APP端直接呼叫使用PTX APIs？**

    PTX平台屬於開放資料平台，為避免網路頻寬及伺服器資源遭特定服務濫用，加值業者務必需自建後台。

- **PTX API的網際網路資源統一資源識別元(URI)是否有規則？**

    PTX API的URI有一定的命名原則(Naming Convention)，詳細請參閱「PTX API URI Convention說明文件」。

- **對於檔案較大的資料服務，建議介接方式？**
    
    整批資料下載因資料量較大，請勿直接取用，建議善用OData Select語法，篩檢所需之資料欄位可大量減少資料量。另若要用OData語法中的top跟skip來批次存取資料時，建議先針對整批資料的主鍵值(PK)進行排序，再進行批次抓取
	> 範例：介接國內定期班表資料，Key值欄位(FlightNumber, ScheduleStartDate)
 [http://ptx.transportdata.tw/MOTC/v2/Air/GeneralSchedule/Domestic?$orderby=FlightNumber,ScheduleStartDate%20asc&$top=5&$skip=0&$format=XML](http://ptx.transportdata.tw/MOTC/v2/Air/GeneralSchedule/Domestic?$orderby=FlightNumber,ScheduleStartDate%20asc&$top=5&$skip=0&$format=XML)
    
	建議對於取用大量資料的需求者，避免直接使用瀏覽器下載，以防止發生因瀏覽器session timeout而導致誤認PTX平台服務出現問題，建議可利用相關程式(如curl指令)將資料直接抓回使用。

- **對於來源端中斷之狀態，加值業者如何判斷？**

    有關各項來源端或PTX端各服務狀態之監控資訊，已規劃納入未來開發之工作項目，後續將提供相關API供會員使用。

- **疑義資料處理程序？**

    PTX平台係與各資料來源端協作模式，進行M2M資料介接，故若有任何資料面議題，平台會協助將問題反映給來源單位，請其協助確認並修正，惟為加速問題釐清，建議將問題佐證畫面與資料併同問題一併提出。

- **是否有提供資料異動紀錄？**

    PTX平台上之各項靜態資料，基本上由本平台每天與各資料來源端進行更新，考量各加值業者對資料版本異動資料之處理需求，未來將規劃提供各項靜態資料之異動檔供大家使用。

- **是否會針對動態資料提供即時推播服務？**

    為提高各運具動態資料之即時性，未來PTX平台將與各資料供應單位協作，縮短資料來源端至PTX平台之時間差，並規劃提供更即時之動態資訊推播服務。
 
## 平台使用指南


1. 註冊使用者帳號，請至註冊會員申請會員。
2. 啟用帳號，會員註冊完畢，信箱內會收到一則『會員帳號啟用信』，須將您所申請的帳號啟用以完成申辦程序。
3. 呼叫Ticket
	
    方法一、
	- 進入線上API說明『使用者登入』
	- 輸入所申辦的帳號及密碼
	- 取得一張Ticket
	
	方法二、
	- 範例程式碼內只要輸入帳號密碼，機器即可自動取得Ticket
		> 範例程式碼：http://ptx.transportdata.tw/MOTC/v2/Account/Login?UserData.account=____&UserData.password=____&%24format=JSON

取得Ticket後，即可開始享用平臺服務內容！

> 備註：後續更完整的API授權機制正在設計實作中, 待確認後再行對外正式公告。
 
## 資料服務版本差別

- V1版：於105年4月公開航空、臺鐵、高鐵、公總公路客運及六都市區公車動靜態資料服務共56筆，市區公車資料及公路客運資料並無做區隔，新北無A1、A2資料僅提供N1動態資料，台中與高雄無A2動態資料，台北市無附屬路線概念。
	> V1會持續運作，但後續並不做任何修改與調整。

	> V1版下架時間另行公告。
- V2版：多輸出相關欄位提供較充分資料內容，便利開發人員直接使用，而不需再與其他API服務做串連間接取得(例如：不單僅輸出StaionID，同時也輸出StationName)。除提供既有V1版的資料服務項目外，於105年8月新增服務內容包含：非六都市區公車動靜態資料、台北市公車班表資料、雙北站位資料、新北動態資料(A1/A2/N1)、公路與國道客運班表資料、航空航班即時到離站資料(以航班為角度)、台鐵列車動態到離站資料等，累計達181項。另外便利開發人員區分市區公車資料及公路客運資料，其Bus API服務調整成以CityBus Api及InterCityBus Api做區隔，公車資料納入主副路線概念。未來，陸續新增服務也將以V2版為基礎持續新增服務內容。

## 航空動靜態資料
1.	介接航空資料時須注意本平臺機場代碼皆以IATA國際代碼三碼為API服務查詢及資料串接之基礎。
2.	即時航班到離站資料(FIDS)分別以機場角度(Airport)及航班(Flight)角度提供資料服務，加值業者在使用時需注意應用面向避免引用錯誤。
3.	航空定期航班班表由民航局及桃園機場提供，目前僅提供客運航班班表資料，國際定期航班班表有包含兩岸航班。
4.	國際定期航班起飛或降落時間有+1的現象，代表Flight Date 日期+1天，並非+1小時唷，因航班日期皆以起飛城市當地時間及降落城市當地時間提供，為了解決班機所遇到之時差問題，如台北飛洛杉磯可能10月07日10:00早上台北起飛，10月07日07:00早上洛杉磯降落，此時航班僅會以10:00標示顯示；但若遇到台北飛孟買，10月09日1:00下午台北起飛，10月10日1:00早上孟買降落，此時就會顯示+1(天)

## 市區公車及公路客運
1.	動態資料傳遞延遲

	公路客運六都市區公車動態資料延遲時間(來源端<->PTX平台)：

|   | 動態資料延遲時間  |
|---|---|
| 公總  | 即時推播，約2~3秒  |
|   |   |
|   |   |
|   |   |
|   |   |
|   |   |
|   |   |

	
	
台北市	約10秒內
新北市	延遲時間不超過30秒
桃園市	約10秒
台中市	約30秒
台南市	約10秒內
高雄市	約30秒
※延遲時間為SrcUpdateTime與UpdateTime時間差。
※非六都縣市皆由公總動態系統代為管理提供，故同公總動態延遲時間。
※台中市與高雄市延遲較長是因為來源端本身有作Cache機制，故即使PTX每6秒Polling跟來源端Polling更新一次，仍無法即時更新資料。

2.	動態資料更新時間資料說明



更新時間項目	中文名稱說明	發生時間
GPSTime	車機時間	最早



最晚
TransTime	車機資料傳輸時間	
SrcRecTime	來源端平台接收時間	
SrcUpdateTime	來源端平台資料更新時間	
UpdateTime	本平台資料更新時間	
※當部分時間邏輯順序不對時，可能原因為系統來源端未將系統做好校時工作。

3.	站牌與站位兩者間之差異
(1)	站牌：一站牌點位若有多條公車路線行經，而各個公車路線擁有各自站牌桿時，就會有多筆站牌資料。
(2)	站位：當多筆站牌資料表示為同一站牌區位時則以站位資料為表示，而站牌與站位間之關聯記錄在站牌基本資料中會有一個站位ID(StationID)代表。如：StationUID為TPE50629(劍潭)，PositionLat: 25.0807666778564, PositionLon: 121.524398803711，此站位只有一筆經緯度資料。目前僅有台北市與新北市提供站位資料，其餘縣市尚無法提供。
4.	為何有些公車路線GIS線型資料分去返程(分2條線型圖資)，有些卻沒有分(只有1條線型圖資)？
此現象係為來源端供應資料現狀，目前六都中僅台北與新北沒有分去返程，其餘都有分去返程。
5.	公路客運路線ID的編碼原則：
前四碼為路線代號、第五碼為正副路線資訊 (A：主路線，B：副路線)、第六碼為去返程資訊 (1：去程，2：返程)，如：路線ID為7011A2，代表此筆當時為7011主路線返程資料。
6.	部分欄位若為空值是因來源單位尚未提供介接，如：新北市N1資料因來源單位未提供StopStatus、NextBusTime、SrcRecTime及SrcUpdateTime資料，故以上欄位皆為空值。 
7.	新北市V1版資料由既有公車動態系統介接；V2版資料由雙北雲系統介接。
8.	公路總局及非六都縣市公車動態資料(A1/A2/N1)，因其採「推播」方式將資料供應給PTX平台，依據公總表示因公路客運站間距離較長，有時N1資料的觸發重算會經過較長的時間，故平台將該等資料保留1小時，若有提供離目前時間1小時左右的資料情況產生，請加值業者依資料使用需求先進行過濾加值，未來PTX平台規劃將資料進行加值應用判斷，將過時的資料濾除，以減少多數加值業者對介接該等資料時通常會產生之疑問。
9.	公路客運為觸發資料，使用者N1資料須注意需自行倒數預估到站時間。
10.	公路客運及公總代管的縣市N1訊息中雖沒有提供路線第1站之下一班車時刻資訊，但可從靜態資料的時刻表與動態GPS點位資料做關連加值，例如：發車時間晚於現在查詢時間但距離目前查詢時間最接近的那班。
11.	公車N1資料經確認過班表資料後，若發現某些路線似乎沒有公車時刻的資料原因主要有兩者
(1)	司機車機系統未開啟
(2)	當下若非路線營運時間，就無預估到站資料。
如公總8232A2路線為例：班表顯示周一至五都有營運，但查詢A1及N1資料時皆無8232A2資料，因為此路線一天只有一班，營運時間僅為06:10，故當您搜尋時間非此時間附近，就無此筆資料。
12.	為何公總的路線站牌資料(StopOfRoute)會多一個營運業者(OperatorID)欄位？
此為公路總局目前資料的特性，與六都並不相同，同一站牌會因為分屬不同的客運業者而有不同的StopID，而預估到站時間資料(N1)中的StopID會與其對應，故加值業者在使用公總的StopOfRoute時，要注意對於同一路線由兩個或多個不同客運業者經營時，會有依營運業者而有不同StopOfRoute之多套清單現象。
13.	為何預估到站資料(N1)有些有車牌號碼有些沒有？而有時候該值為負值？
(1)	部分縣市(如台北市)並沒有在預估到站資料(N1)中提供車牌號碼欄位資料。
(2)	公總預估到站資料(N1)中，有時該值為＂-1＂，當發生此狀況時，表示車輛已過該站，例如某路線共有10個站，若某車牌已經通過第3站，則其第1~3站的預估到站資料的車牌號碼欄位值將為＂-1＂且其預估到站時間欄位不會有值，而第4~10站的車牌號碼及預估到站欄位都會有值。
14.	六都與公總提供預估到站時間資料(N1)之作法有點不同，若同一路線上同時有多台車在線上進行服務時，六都所提供的N1資料會進行相關的聚合(Aggregation)，僅提供距該路線最近車輛之預估時間資料，而公總則是提供各車輛對每個站的預估到站時間資料，並沒有進行相關聚合，而公總做法雖然最為原始但也讓加值業者有更多的創意應用空間。
15.	公車時刻表資料：部分市區公車路線的時刻表資料(如台北市255路線)，同時會包含班距的時刻與班表的時刻(如:晚上9:00採固定班距，之後採固定時刻表)；另外公路總局及其代管系統縣市(除六都+基隆+連江+金門)之時刻表資料，不一定含全部站點的時刻資料，有些只有重要站點才有時刻資訊；有些只有路線起始站(第1站)才有時刻資訊。
16.	公路客運路線時刻表資料，會因同一路線由多家客運業者聯營，故會有不同客運業者有不同時刻表資料之情形。
17.	起訖站中英文名稱：此資料欄位由各縣市來源單位提供，部分縣市並非以路線起迄站名稱提供，而是以平常慣用的路線Headsign的起迄名稱。另部分縣市如台南縣市，目前提供的迄站名稱中，並非只放一個站名，尚包含中間站名，例如：台南 [黃6] 路線的迄站名稱，放的是「白沙屯 ─ 後壁火車站」而非「後壁火車站」，加值業者在使用時請多加留意。
18.	站牌點位資料品質：部分縣市站牌點位座標經緯度值為0(如：基隆市)，是因為部分縣市正進行站牌點位的盤點清查作業，來源單位為確保資料正確性，將於資料盤點確認完畢後才能正式提供，故需耐心等候一段時間。另有關站牌點位座標的品質，會持續透過空間檢核技術與資料產製單位持續精進品質。
19.	有關雙北雲站牌StopID的編碼原則：(目前新北市資料由此平台提供)
[AAAAA]-[BBB]-[C]-[D]
[AAA+AA]：3+2郵遞區號
[BBB]：站位編碼，相同郵遞區號且站名相同視為同一站位
[C]：方位碼(0~7)
[D] ：相同站位之流水號，由東向西依序編列

（四）雙鐵動靜資料
1.	台鐵列車到離站動態即時電子看板資料(Liveboard)，目前延遲時間為2分鐘，該資料與台鐵官網的列車動態資料來源一致，但與車站或月台上即時顯示的TIDS看板並非一致，會有時間上的延遲，故加值業者在該項資料使用上，請注意並請勿直接與車站或月台上的TIDS看板進行比對，並提醒民眾進入車站主體後，即請以車站內部系統顯示的動態資訊為主。
2.	雙鐵臨時加班資訊：雙鐵僅提供前一天異動資訊，目前尚無法提供當日臨時加班資訊。
3.	列車即時準點/誤點資料與列車到離站動態資料之差異：
列車即時準點/誤點資料為台鐵提供的原始資料，經由該資料與每日時刻表資料進行關連，PTX平台進行加值後提供列車到離站動態資料供加值業者使用。
4.	定期時刻表與每日時刻表之差異：為確保時刻表的正確性及即時性，台鐵提供近60天每日時刻表、高鐵提供近45天每日時刻表，然而考量國內外旅客對於在臺旅行常需在數個月前規劃行程，若超過此段期間之時刻表資料則可參考定期時刻表，提供未來數個月之後之旅運規劃服務(通常國外旅客來台觀光較需要使用定期時刻表資料)。
5.	車站代碼(StationID)與車站簡碼(StationCode)之差異：StationID通常為列車排點系統的車站代碼系統，時刻表資料中即以此代碼為主；StationCode主要是票務系統如訂票系統用的車站簡碼，加值業者使用時必須先了解其差異與使用時機。

